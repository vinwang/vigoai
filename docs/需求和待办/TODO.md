# AI漫导 Agent - 待办事项列表

> 更新时间: 2025-12-29
> 当前状态: 基础对话、图片生成、视频生成、人物一致性功能已完成

---

## 当前开发任务 (Next Tasks)
- [✅] 对剧本人物一致性的要求提示词和流程优化，要求生成的第一张分镜图片 url作为剧本的主人公,传入到第二张分镜，第三张分镜。
      最后传入到视频。以此来保证人物一致性。要让 glm给出相应的题词来保证。

      **实现说明：**
      1. **Scene 模型新增 `character_description` 字段** - 用于存储人物特征描述
      2. **GLM 提示词优化** - 要求输出人物描述，所有场景使用相同描述，后续场景在 image_prompt 中引用第一张图的人物特征
      3. **图片生成流程优化** - 后续场景在生成图片时，prompt 前添加人物描述作为参考
      4. **视频生成流程优化** - 使用第一张图作为主人公参考，在 prompt 中添加人物描述

---

## 已完成 ✅

- [✅] 项目基础架构搭建 (Flutter + Provider + Dio)
- [✅] 对话界面 (ChatScreen)
- [✅] 消息模型 (ChatMessage)
- [✅] API 服务封装 (ApiService)
- [✅] 智谱 GLM-4.7 对话接口
- [✅] Gemini 图像生成接口
- [✅] Tuzi Sora 视频生成接口
- [✅] 基础 Agent 工具调用框架 (generate_image, generate_video, complete)
- [✅] 基础 Agent 工具调用框架 (generate_image, generate_video, complete)
- [✅] 创建剧本数据模型 (Script, Scene)
- [✅] 优化 GLM 系统提示词为剧本规划模式
- [✅] 实现剧本解析器 (JSON 解析与校验)
- [✅] 创建任务进度追踪器 UI 组件
- [✅] 实现批量图片生成逻辑
- [✅] 实现批量视频生成逻辑
- [✅] 创建剧本展示组件 (Markdown + 卡片)
- [✅] 添加错误重试机制

---

## 核心功能开发

### 第一阶段: 剧本规划层 (Brain/Planner)

#### 1.1 剧本数据模型设计
- [ ] 创建 `Script` 模型类
  ```dart
  class Script {
    String taskId;
    String scriptTitle;
    List<Scene> scenes;
  }
  ```
- [ ] 创建 `Scene` 模型类
  ```dart
  class Scene {
    int sceneId;
    String narration;        // 中文旁白
    String imagePrompt;      // 生图提示词
    String videoPrompt;      // 视频动效提示词
    String? imageUrl;        // 生成的图片 URL
    String? videoUrl;        // 生成的视频 URL
    String status;           // pending/image_generating/video_generating/completed/failed
  }
  ```

#### 1.2 GLM 系统提示词优化
- [ ] 设计剧本规划的系统提示词
  - 要求 GLM 输出结构化的 JSON 剧本
  - 包含分镜、旁白、image_prompt、video_prompt
- [ ] 添加示例到系统提示词，确保输出格式稳定

#### 1.3 剧本解析器
- [ ] 实现 JSON 解析和校验逻辑
- [ ] 处理解析失败的容错机制

---

### 第二阶段: 资产创作层 (Worker/Visualizer)

#### 2.1 并行图片生成
- [ ] 支持批量生成多个场景的图片
- [ ] 图片生成进度回调
- [ ] 单场景失败重试机制

#### 2.2 图片缓存与存储
- [ ] 下载图片到本地缓存
- [ ] 图片压缩优化

---

### 第三阶段: 动态合成层 (Synthesizer/Animator)

#### 3.1 批量视频生成
- [ ] 遍历所有已生成图片的场景，生成视频
- [ ] 视频生成进度追踪

#### 3.2 异步任务轮询优化
- [ ] 改进轮询策略（避免频繁请求）
- [ ] 超时处理

#### 3.3 视频拼接 (可选)
- [ ] 如果有多个场景，考虑视频拼接功能
- [ ] 使用 ffmpeg 或其他方案

---

### 第四阶段: 交互式展示 (User Interface)

#### 4.1 任务进度追踪器 UI
- [ ] 创建进度条组件
  - 显示状态: `规划中` -> `生成图片 (1/3)` -> `生成视频` -> `完成`
- [ ] 动画效果优化

#### 4.2 剧本展示组件
- [ ] 使用 `flutter_markdown` 渲染剧本
- [ ] 分镜卡片展示（图片 + 旁白）

#### 4.3 多模态卡片优化
- [ ] 图片网格展示（支持点击放大）
- [ ] 视频播放器优化
- [ ] 下载/分享功能

#### 4.4 错误处理与重试
- [ ] 失败场景显示"重试"按钮
- [ ] 错误提示优化

---

## 代码优化

### 架构优化
- [ ] 分离 Agent Controller 的职责
  - `ScriptPlanner`: 负责剧本规划
  - `ImageGenerator`: 负责图片生成
  - `VideoGenerator`: 负责视频生成
- [ ] 添加单元测试

### 性能优化
- [ ] 大图片/视频的懒加载
- [ ] 内存优化（及时清理缓存）

---

## 配置与部署

- [ ] 环境配置管理（开发/生产环境 API Key）
- [ ] 添加用户协议和隐私政策
- [ ] 应用图标和启动页

---

## 文档完善

- [ ] API 接口文档整理
- [ ] 用户使用手册
- [ ] 开发者文档

---

## 优先级说明

**P0 (最高优先级)**
- 剧本数据模型设计
- GLM 系统提示词优化
- 任务进度追踪器 UI

**P1 (高优先级)**
- 批量图片/视频生成
- 剧本展示组件
- 错误处理与重试

**P2 (中优先级)**
- 视频拼接功能
- 缓存优化
- 单元测试

**P3 (低优先级)**
- 下载/分享功能
- 用户协议
- 应用图标
